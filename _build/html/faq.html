<!DOCTYPE html>
<html class="writer-html4" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Frequently Asked Questions (FAQ) &mdash; Ansible Galaxy FortiOS Collection 1.0 documentation</title><link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/theme_overrides.css" type="text/css" />
      <link rel="stylesheet" href="_static/collapse.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
        <script type="text/javascript" src="_static/util.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Get Help" href="help.html" />
    <link rel="prev" title="Run Your First Playbook" href="playbook.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> Ansible Galaxy FortiOS Collection
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption"><span class="caption-text">FortiOS/Galaxy Version Mapping Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="version.html">FortiOS Galaxy Versioning</a></li>
</ul>
<p class="caption"><span class="caption-text">User's Guide</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="install.html">Install FortiOS Ansible Galaxy</a></li>
<li class="toctree-l1"><a class="reference internal" href="playbook.html">Run Your First Playbook</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Frequently Asked Questions (FAQ)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#what-s-access-token">What’s Access Token?</a></li>
<li class="toctree-l2"><a class="reference internal" href="#how-to-backup-and-restore-fos">How To Backup And Restore FOS?</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#backup-settings-to-local-file">Backup settings to local file.</a></li>
<li class="toctree-l3"><a class="reference internal" href="#restore-settings-from-local-file">Restore settings from local file.</a></li>
<li class="toctree-l3"><a class="reference internal" href="#restore-settings-from-other-sources">Restore settings from other sources.</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#how-to-import-a-license">How To Import A License?</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#import-a-license-for-a-newly-installed-fos-instance">Import a license for a newly installed FOS instance.</a></li>
<li class="toctree-l3"><a class="reference internal" href="#renew-a-license-for-a-licence-ready-fos-instance">Renew a license for a licence-ready FOS instance.</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#how-does-ansible-work-with-login-banner">How does Ansible work with login banner?</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#what-s-login-banner">what’s login banner?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#how-to-safely-generate-access-token">How to safely generate access token?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#where-to-keep-generated-access-token">where to keep generated access token?</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#how-to-work-with-raw-fotios-cli">How To Work With Raw FotiOS CLI?</a></li>
<li class="toctree-l2"><a class="reference internal" href="#how-to-use-the-set-fact-module-in-a-task">How to use the set_fact module in a task?</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="help.html">Get Help</a></li>
</ul>
<p class="caption"><span class="caption-text">modules index</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="modules.html">Configuration Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="monitor.html">Monitor Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="fact.html">Facts Gathering Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="export.html">Export playbooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="generic.html">Generic Modules</a></li>
</ul>
<p class="caption"><span class="caption-text">Appendices</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="release.html">Release Notes</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Ansible Galaxy FortiOS Collection</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Frequently Asked Questions (FAQ)</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/faq.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="frequently-asked-questions-faq">
<h1>Frequently Asked Questions (FAQ)<a class="headerlink" href="#frequently-asked-questions-faq" title="Permalink to this headline">¶</a></h1>
<div class="line-block">
<div class="line"><br /></div>
</div>
<dl class="docutils">
<dt><strong>TABLE OF CONTENTS:</strong></dt>
<dd><ul class="first last simple">
<li><a class="reference internal" href="#what-s-access-token">What’s Access Token?</a></li>
<li><a class="reference internal" href="#how-to-backup-and-restore-fos">How To Backup And Restore FOS?</a></li>
<li><a class="reference internal" href="#how-to-import-a-license">How To Import A License?</a></li>
<li><a class="reference internal" href="#how-does-ansible-work-with-login-banner">How does Ansible work with login banner?</a></li>
<li><a class="reference internal" href="#how-to-work-with-raw-fotios-cli">How To Work With Raw FotiOS CLI?</a></li>
<li><a class="reference internal" href="#how-to-use-the-set-fact-module-in-a-task">How to use the set_fact module in a task?</a></li>
</ul>
</dd>
</dl>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="what-s-access-token">
<h2>What’s Access Token?<a class="headerlink" href="#what-s-access-token" title="Permalink to this headline">¶</a></h2>
<p>Access Token here is an API token which is used to authenticate an API request, an api token is associated with an API user once generated in FortiOS.
FortiOS Ansible supports api token based authentication, please see <a class="reference external" href="playbook.html">Run Your Playbook</a> for how to use <code class="docutils literal notranslate"><span class="pre">access_token</span></code> in Ansible playbook.</p>
<p>Sometimes we also want to dynamically generate an API token via FortiOS ansible module, we have a demo to show how to generate an API token:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># to customize privileges for the API user, we can also define an accprofile via module fortios_system_accprofile.</span>
<span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">Create</span> <span class="n">An</span> <span class="n">API</span> <span class="n">User</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">present</span>
  <span class="n">fortios_system_api_user</span><span class="p">:</span>
     <span class="n">vdom</span><span class="p">:</span> <span class="s1">&#39;root&#39;</span>
     <span class="n">state</span><span class="p">:</span> <span class="s1">&#39;present&#39;</span>
     <span class="n">system_api_user</span><span class="p">:</span>
         <span class="n">name</span><span class="p">:</span> <span class="s1">&#39;AnsibleAPIUser&#39;</span>
         <span class="n">accprofile</span><span class="p">:</span> <span class="s1">&#39;super_admin&#39;</span> <span class="c1"># This is predefined privilege profile.</span>
         <span class="n">vdom</span><span class="p">:</span>
            <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="s1">&#39;root&#39;</span>
         <span class="n">trusthost</span><span class="p">:</span>
             <span class="o">-</span> <span class="nb">id</span><span class="p">:</span> <span class="s1">&#39;1&#39;</span>
               <span class="n">ipv4_trusthost</span><span class="p">:</span> <span class="s1">&#39;192.168.190.0 255.255.255.0&#39;</span>

<span class="c1"># To reference the generated token, we can use notation &quot;{{ tokeninfo.meta.results.access_token  }}&quot;in further tasks or keep it somewhere in disk.</span>
<span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">Generate</span> <span class="n">The</span> <span class="n">API</span> <span class="n">token</span>
  <span class="n">fortios_monitor</span><span class="p">:</span>
     <span class="n">vdom</span><span class="p">:</span> <span class="s1">&#39;root&#39;</span>
     <span class="n">selector</span><span class="p">:</span> <span class="s1">&#39;generate-key.system.api-user&#39;</span>
     <span class="n">params</span><span class="p">:</span>
         <span class="n">api</span><span class="o">-</span><span class="n">user</span><span class="p">:</span> <span class="s1">&#39;AnsibleAPIUser&#39;</span>
  <span class="n">register</span><span class="p">:</span> <span class="n">tokeninfo</span>

<span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">do</span> <span class="n">another</span> <span class="n">api</span> <span class="n">request</span> <span class="k">with</span> <span class="n">newly</span> <span class="n">generated</span> <span class="n">access_token</span>
  <span class="n">fortios_configuration_fact</span><span class="p">:</span>
     <span class="n">access_token</span><span class="p">:</span> <span class="s2">&quot;{{ tokeninfo.meta.results.access_token  }}&quot;</span>
     <span class="n">vdom</span><span class="p">:</span> <span class="s1">&#39;root&#39;</span>
     <span class="n">selector</span><span class="p">:</span> <span class="s1">&#39;system_status&#39;</span>
</pre></div>
</div>
</div>
<div class="section" id="how-to-backup-and-restore-fos">
<h2>How To Backup And Restore FOS?<a class="headerlink" href="#how-to-backup-and-restore-fos" title="Permalink to this headline">¶</a></h2>
<p>Legacy module <code class="docutils literal notranslate"><span class="pre">fortios_system_config_backup_restore</span></code> is deprecated since 2.0.0, new modules are available for doing equivalent jobs.
New modules are desined to be very flexible, that requires us to combine modules to do complex task.</p>
<p><strong>Note: operation backup and restore needs administrative privilege, better not choose access token based authentication.</strong></p>
<div class="section" id="backup-settings-to-local-file">
<h3>Backup settings to local file.<a class="headerlink" href="#backup-settings-to-local-file" title="Permalink to this headline">¶</a></h3>
<p>FortiOS Ansible collection doesn’t provide any modules for local file operations, here we use builtin <code class="docutils literal notranslate"><span class="pre">copy</span></code> module to copy plain configuration text into a file.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">Backup</span> <span class="n">a</span> <span class="n">virtual</span> <span class="n">domain</span><span class="o">.</span>
  <span class="n">fortios_monitor_fact</span><span class="p">:</span>
     <span class="n">selector</span><span class="p">:</span> <span class="s1">&#39;system_config_backup&#39;</span>
     <span class="n">vdom</span><span class="p">:</span> <span class="s1">&#39;root&#39;</span>
     <span class="n">params</span><span class="p">:</span>
         <span class="n">scope</span><span class="p">:</span> <span class="s1">&#39;global&#39;</span>
  <span class="n">register</span><span class="p">:</span> <span class="n">backupinfo</span>

<span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">Save</span> <span class="n">the</span> <span class="n">backup</span> <span class="n">information</span><span class="o">.</span>
  <span class="n">copy</span><span class="p">:</span>
     <span class="n">content</span><span class="p">:</span> <span class="s1">&#39;{{ backupinfo.meta.raw }}&#39;</span>
     <span class="n">dest</span><span class="p">:</span> <span class="s1">&#39;./local.backup&#39;</span>
</pre></div>
</div>
</div>
<div class="section" id="restore-settings-from-local-file">
<h3>Restore settings from local file.<a class="headerlink" href="#restore-settings-from-local-file" title="Permalink to this headline">¶</a></h3>
<p>FortiOS only accepts base64 encoded text, the configuration text must be encoded before being uploaded.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">Restore</span> <span class="kn">from</span> <span class="nn">file.</span>
  <span class="n">fortios_monitor</span><span class="p">:</span>
     <span class="n">selector</span><span class="p">:</span> <span class="s1">&#39;restore.system.config&#39;</span>
     <span class="n">vdom</span><span class="p">:</span> <span class="s1">&#39;root&#39;</span>
     <span class="n">params</span><span class="p">:</span>
         <span class="n">scope</span><span class="p">:</span> <span class="s1">&#39;global&#39;</span>
         <span class="n">source</span><span class="p">:</span> <span class="s1">&#39;upload&#39;</span>
         <span class="n">vdom</span><span class="p">:</span> <span class="s1">&#39;root&#39;</span>
         <span class="n">file_content</span><span class="p">:</span> <span class="s2">&quot;{{ lookup( &#39;file&#39;, &#39;./local.backup&#39;) | string | b64encode }}&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="restore-settings-from-other-sources">
<h3>Restore settings from other sources.<a class="headerlink" href="#restore-settings-from-other-sources" title="Permalink to this headline">¶</a></h3>
<p>no matter what source is, just make sure content is encoded.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">Backup</span> <span class="n">a</span> <span class="n">virtual</span> <span class="n">domain</span><span class="o">.</span>
  <span class="n">fortios_monitor_fact</span><span class="p">:</span>
     <span class="n">selector</span><span class="p">:</span> <span class="s1">&#39;system_config_backup&#39;</span>
     <span class="n">vdom</span><span class="p">:</span> <span class="s1">&#39;root&#39;</span>
     <span class="n">params</span><span class="p">:</span>
         <span class="n">scope</span><span class="p">:</span> <span class="s1">&#39;global&#39;</span>
  <span class="n">register</span><span class="p">:</span> <span class="n">backupinfo</span>

<span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">Restore</span> <span class="kn">from</span> <span class="nn">intermediate</span> <span class="n">result</span><span class="o">.</span>
  <span class="n">fortios_monitor</span><span class="p">:</span>
     <span class="n">selector</span><span class="p">:</span> <span class="s1">&#39;restore.system.config&#39;</span>
     <span class="n">vdom</span><span class="p">:</span> <span class="s1">&#39;root&#39;</span>
     <span class="n">params</span><span class="p">:</span>
         <span class="n">scope</span><span class="p">:</span> <span class="s1">&#39;global&#39;</span>
         <span class="n">source</span><span class="p">:</span> <span class="s1">&#39;upload&#39;</span>
         <span class="n">vdom</span><span class="p">:</span> <span class="s1">&#39;root&#39;</span>
         <span class="n">file_content</span><span class="p">:</span> <span class="s2">&quot;{{ backupinfo.meta.raw | string | b64encode}}&quot;</span>
</pre></div>
</div>
<p>For more options to restore, see module <code class="docutils literal notranslate"><span class="pre">fortios_monitor</span></code> and its selector <code class="docutils literal notranslate"><span class="pre">restore.system.config</span></code>,
for more options to backup, see module <code class="docutils literal notranslate"><span class="pre">fortios_monitor_fact</span></code> and its selector <code class="docutils literal notranslate"><span class="pre">system_config_backup</span></code>.</p>
</div>
</div>
<div class="section" id="how-to-import-a-license">
<h2>How To Import A License?<a class="headerlink" href="#how-to-import-a-license" title="Permalink to this headline">¶</a></h2>
<div class="section" id="import-a-license-for-a-newly-installed-fos-instance">
<h3>Import a license for a newly installed FOS instance.<a class="headerlink" href="#import-a-license-for-a-newly-installed-fos-instance" title="Permalink to this headline">¶</a></h3>
<p>Make sure the active management port allows access to http service by setting <code class="docutils literal notranslate"><span class="pre">allowaccess</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FortiGate</span><span class="o">-</span><span class="n">VM64</span> <span class="c1"># show system interface port1</span>
<span class="n">config</span> <span class="n">system</span> <span class="n">interface</span>
<span class="n">edit</span> <span class="s2">&quot;port1&quot;</span>
    <span class="nb">set</span> <span class="n">vdom</span> <span class="s2">&quot;root&quot;</span>
    <span class="nb">set</span> <span class="n">mode</span> <span class="n">dhcp</span>
    <span class="nb">set</span> <span class="n">allowaccess</span> <span class="n">ping</span> <span class="n">https</span> <span class="n">ssh</span> <span class="n">http</span> <span class="n">fgfm</span>
    <span class="nb">set</span> <span class="nb">type</span> <span class="n">physical</span>
    <span class="nb">set</span> <span class="n">snmp</span><span class="o">-</span><span class="n">index</span> <span class="mi">1</span>
<span class="nb">next</span>
<span class="n">end</span>
</pre></div>
</div>
<p>Then run the following playbook to upload licence for the first time:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">hosts</span><span class="p">:</span> <span class="n">fortigate_new</span>
  <span class="n">connection</span><span class="p">:</span> <span class="n">httpapi</span>
  <span class="n">collections</span><span class="p">:</span>
   <span class="o">-</span> <span class="n">fortinet</span><span class="o">.</span><span class="n">fortios</span>
  <span class="nb">vars</span><span class="p">:</span>
   <span class="n">vdom</span><span class="p">:</span> <span class="s2">&quot;root&quot;</span>
   <span class="n">ansible_httpapi_use_ssl</span><span class="p">:</span> <span class="n">no</span>
   <span class="n">ansible_httpapi_validate_certs</span><span class="p">:</span> <span class="n">no</span>
   <span class="n">ansible_httpapi_port</span><span class="p">:</span> <span class="mi">80</span>
   <span class="n">ansible_command_timeout</span><span class="p">:</span> <span class="mi">5</span>
  <span class="n">tasks</span><span class="p">:</span>

   <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">Upload</span> <span class="n">the</span> <span class="n">license</span> <span class="n">to</span> <span class="n">the</span> <span class="n">newly</span> <span class="n">installed</span> <span class="n">FGT</span> <span class="n">device</span>
     <span class="n">fortios_monitor</span><span class="p">:</span>
         <span class="n">vdom</span><span class="p">:</span> <span class="s2">&quot;{{ vdom }}&quot;</span>
         <span class="n">selector</span><span class="p">:</span> <span class="s1">&#39;upload.system.vmlicense&#39;</span>
         <span class="n">params</span><span class="p">:</span>
             <span class="n">file_content</span><span class="p">:</span> <span class="s2">&quot;{{ lookup( &#39;file&#39;, &#39;./FGVM02TM20012347.lic&#39;) | string | b64encode }}&quot;</span>
     <span class="n">ignore_errors</span><span class="p">:</span> <span class="kc">True</span>
</pre></div>
</div>
<p>In the example, we put license file <code class="docutils literal notranslate"><span class="pre">FGVM02TM20012347.lic</span></code> under current working directory.</p>
<p>Once FOS accepts a valid licence, it reboots immediately and the connection terminates suddenly, as a result, we must not regard connection timeout as errors, we’d better ignore connection timeout exception.
and the default connection timeout is 30 seconds, better make it smaller.</p>
<p><strong>Access token based authentication is not allowed in initial license import</strong></p>
</div>
<div class="section" id="renew-a-license-for-a-licence-ready-fos-instance">
<h3>Renew a license for a licence-ready FOS instance.<a class="headerlink" href="#renew-a-license-for-a-licence-ready-fos-instance" title="Permalink to this headline">¶</a></h3>
<p>To renew the license for a running FOS instance, we don’t have to use http service (by default, after license is activated, http service is redirected to https service, which causes problems for Ansible).
by setting <code class="docutils literal notranslate"><span class="pre">ansible_httpapi_use_ssl</span></code> to <code class="docutils literal notranslate"><span class="pre">True</span></code> and <code class="docutils literal notranslate"><span class="pre">ansible_httpapi_port</span></code> to <code class="docutils literal notranslate"><span class="pre">443</span></code>, the task can normally upload the license.</p>
<p><strong>Renewing a license can use access token based authentication as long as associated API user has admin privilege to upload license.</strong></p>
</div>
</div>
<div class="section" id="how-does-ansible-work-with-login-banner">
<h2>How does Ansible work with login banner?<a class="headerlink" href="#how-does-ansible-work-with-login-banner" title="Permalink to this headline">¶</a></h2>
<div class="section" id="what-s-login-banner">
<h3>what’s login banner?<a class="headerlink" href="#what-s-login-banner" title="Permalink to this headline">¶</a></h3>
<p>FOS puts a barrier in login process if pre- and(or) post- login bannner are enabled, and ansible authentication is restricted: <strong>only access token based authentication is allowed</strong>.</p>
</div>
<div class="section" id="how-to-safely-generate-access-token">
<h3>How to safely generate access token?<a class="headerlink" href="#how-to-safely-generate-access-token" title="Permalink to this headline">¶</a></h3>
<p>For Ansible FOS login banner usage, there could be a <code class="docutils literal notranslate"><span class="pre">deadlock</span></code> if one the of following cases apprears:</p>
<blockquote>
<div><ul class="simple">
<li>I don’t have an API user or access token.</li>
<li>I have an access token but it has expired.</li>
</ul>
</div></blockquote>
<p>upon such deadlocks, there is no other way but to disable banners and (re)generate one.</p>
<p>To generate an access token in advance, please see <a class="reference external" href="faq.html#what-s-access-token">How To Generate Access Token Dynamically</a>, and please do token generation with Ansible with all the login banners disabled(it’s not necessay to disable banners if we generate access token from WEB UI).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FGVM02TM20012347</span> <span class="c1"># config system global</span>
<span class="n">FGVM02TM20012347</span> <span class="p">(</span><span class="k">global</span><span class="p">)</span> <span class="c1"># set post-login-banner disable</span>
<span class="n">FGVM02TM20012347</span> <span class="p">(</span><span class="k">global</span><span class="p">)</span> <span class="c1"># set pre-login-banner disable</span>
<span class="n">FGVM02TM20012347</span> <span class="p">(</span><span class="k">global</span><span class="p">)</span> <span class="c1"># end</span>
<span class="n">FGVM02TM20012347</span> <span class="c1">#</span>
</pre></div>
</div>
</div>
<div class="section" id="where-to-keep-generated-access-token">
<h3>where to keep generated access token?<a class="headerlink" href="#where-to-keep-generated-access-token" title="Permalink to this headline">¶</a></h3>
<p>Normally if we generate an access token from WEB UI, we may put it in inventory file as a variable <code class="docutils literal notranslate"><span class="pre">fortios_access_token</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">fortigates</span><span class="p">]</span>
<span class="n">fortigate01</span> <span class="n">ansible_host</span><span class="o">=&lt;</span><span class="n">the</span> <span class="n">address</span> <span class="n">of</span> <span class="n">the</span> <span class="n">host</span><span class="o">&gt;</span> <span class="n">fortios_access_token</span><span class="o">=&lt;</span><span class="n">the</span> <span class="n">access</span> <span class="n">token</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>we can encrypt the inventory file through ansible tool <code class="docutils literal notranslate"><span class="pre">ansible-vault</span></code>, thus avoiding token leaks.</p>
<p>To automate token (re)generation, we might also want to keep it somewhere else in local storage. An example is given below to show how to save and re-use a token later:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">Generate</span> <span class="n">The</span> <span class="n">API</span> <span class="n">token</span>
  <span class="n">fortios_monitor</span><span class="p">:</span>
     <span class="n">vdom</span><span class="p">:</span> <span class="s1">&#39;root&#39;</span>
     <span class="n">selector</span><span class="p">:</span> <span class="s1">&#39;generate-key.system.api-user&#39;</span>
     <span class="n">params</span><span class="p">:</span>
         <span class="n">api</span><span class="o">-</span><span class="n">user</span><span class="p">:</span> <span class="s1">&#39;AnsibleAPIUser&#39;</span>
  <span class="n">register</span><span class="p">:</span> <span class="n">tokeninfo</span>

<span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">Save</span> <span class="n">the</span> <span class="n">API</span> <span class="n">token</span>
  <span class="n">copy</span><span class="p">:</span>
     <span class="n">content</span><span class="p">:</span> <span class="s2">&quot;{{ tokeninfo.meta.results.access_token }}&quot;</span>
     <span class="n">dest</span><span class="p">:</span> <span class="s1">&#39;./access_token.save&#39;</span>
</pre></div>
</div>
<p>then in subsequent tasks, we read the token directly from saved file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">vars</span><span class="p">:</span>
 <span class="n">vdom</span><span class="p">:</span> <span class="s2">&quot;root&quot;</span>
 <span class="n">ansible_httpapi_use_ssl</span><span class="p">:</span> <span class="n">yes</span>
 <span class="n">ansible_httpapi_validate_certs</span><span class="p">:</span> <span class="n">no</span>
 <span class="n">ansible_httpapi_port</span><span class="p">:</span> <span class="mi">443</span>
 <span class="n">saved_access_token</span><span class="p">:</span> <span class="s2">&quot;{{ lookup( &#39;file&#39;, &#39;./access_token.save&#39;) | string }}&quot;</span>

<span class="n">tasks</span><span class="p">:</span>
 <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">do</span> <span class="n">another</span> <span class="n">api</span> <span class="n">request</span> <span class="k">with</span> <span class="n">saved</span> <span class="n">access_token</span>
   <span class="n">fortios_configuration_fact</span><span class="p">:</span>
     <span class="n">access_token</span><span class="p">:</span> <span class="s2">&quot;{{ saved_access_token }}&quot;</span>
     <span class="n">vdom</span><span class="p">:</span> <span class="s1">&#39;root&#39;</span>
     <span class="n">selector</span><span class="p">:</span> <span class="s1">&#39;system_status&#39;</span>
</pre></div>
</div>
<p><strong>Caveats: saved access token is not guarded by Ansible, once leaked, others may access the FOS illegally. one way to restrict illegal access is to limit source localtion in ipv4_trusthost during creating the API users.</strong></p>
</div>
</div>
<div class="section" id="how-to-work-with-raw-fotios-cli">
<h2>How To Work With Raw FotiOS CLI?<a class="headerlink" href="#how-to-work-with-raw-fotios-cli" title="Permalink to this headline">¶</a></h2>
<p>In FortiOS, some CLI commands are not exported as RestAPI, as a reasult, Ansible FortiOS collection has no identical module for those CLI commands.
And FortiOS default CLI shell is not a standard Unix shell, so Ansible builtin modules like <code class="docutils literal notranslate"><span class="pre">shell</span></code> and <code class="docutils literal notranslate"><span class="pre">command</span></code> are of no use.
To work this around in Ansible, we use a verbose but very efficient and flexible way to execute some FortiOS CLI commands from Ansible.</p>
<p>Below are two examples of the template:</p>
<p><strong>Append a firewall address member to a group using append command:</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">hosts</span><span class="p">:</span> <span class="n">localhost</span>
  <span class="nb">vars</span><span class="p">:</span>
    <span class="c1"># ======================== Below are crenditials to connect to Fortigate Device========</span>
    <span class="n">fgt_host</span><span class="p">:</span> <span class="s1">&#39;192.168.190.171&#39;</span>
    <span class="n">fgt_user</span><span class="p">:</span> <span class="s1">&#39;admin&#39;</span>
    <span class="n">fgt_pass</span><span class="p">:</span> <span class="s1">&#39;password&#39;</span>

    <span class="n">firewall_group_name</span><span class="p">:</span> <span class="s1">&#39;firwalladdressgroup0&#39;</span>
    <span class="n">firewall_address_name</span><span class="p">:</span> <span class="s1">&#39;firewalladdress0&#39;</span>
    <span class="c1"># =====================================================================================</span>
    <span class="n">script_path</span><span class="p">:</span> <span class="s1">&#39;/tmp/fgt.shell.task&#39;</span>
  <span class="n">tasks</span><span class="p">:</span>
   <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">Prepare</span> <span class="n">The</span> <span class="n">Shell</span> <span class="n">Scrit</span> <span class="n">Template</span><span class="o">.</span>
     <span class="n">raw</span><span class="p">:</span> <span class="o">|</span>
            <span class="n">cat</span> <span class="o">&gt;</span> <span class="p">{{</span><span class="n">script_path</span> <span class="p">}}</span> <span class="o">&lt;&lt;</span> <span class="n">EOF_OUTER</span>
            <span class="c1"># /bin/bash</span>
            <span class="c1"># Please make sure tool sshpass is installed. e.g. on Debian/Ubuntu, apt-get install sshpass.</span>
            <span class="c1"># Optionally you can pass some parameters.</span>
            <span class="c1"># The character `a` at second line below is to avoid post-login-banner barrier.</span>
            <span class="n">sshpass</span> <span class="o">-</span><span class="n">p</span> <span class="s1">&#39;{{ fgt_pass }}&#39;</span> <span class="n">ssh</span> <span class="o">-</span><span class="n">o</span> <span class="n">StrictHostKeyChecking</span><span class="o">=</span><span class="n">no</span> <span class="p">{{</span> <span class="n">fgt_user</span> <span class="p">}}</span><span class="o">@</span><span class="p">{{</span> <span class="n">fgt_host</span> <span class="p">}}</span> <span class="o">&lt;&lt;</span><span class="n">EOF</span>
            <span class="n">a</span>
            <span class="c1"># ====================== Edit Your Commands Below =============================================</span>
            <span class="n">config</span> <span class="n">firewall</span> <span class="n">addrgrp</span>
            <span class="n">edit</span> <span class="s1">&#39;\$1&#39;</span>
            <span class="n">append</span> <span class="n">member</span> <span class="s1">&#39;\$2&#39;</span>
            <span class="n">end</span>
            <span class="c1"># ==============================================================================================</span>
            <span class="n">EOF</span>
            <span class="n">EOF_OUTER</span>


   <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">Execute</span> <span class="n">The</span> <span class="n">Cli</span> <span class="n">Commands</span><span class="o">.</span>
     <span class="n">raw</span><span class="p">:</span> <span class="o">|</span>
            <span class="n">chmod</span> <span class="o">+</span><span class="n">x</span> <span class="p">{{</span> <span class="n">script_path</span> <span class="p">}}</span> <span class="o">&amp;&amp;</span> <span class="p">{{</span> <span class="n">script_path</span> <span class="p">}}</span> <span class="s1">&#39;{{ firewall_group_name }}&#39;</span> <span class="s1">&#39;{{ firewall_address_name }}&#39;</span>
     <span class="n">args</span><span class="p">:</span>
       <span class="n">executable</span><span class="p">:</span> <span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">bash</span>
</pre></div>
</div>
<p><strong>Enable/Disable pre-/post- login banners</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">hosts</span><span class="p">:</span> <span class="n">localhost</span>
  <span class="nb">vars</span><span class="p">:</span>
    <span class="c1"># ======================== Below are crenditials to connect to Fortigate Device========</span>
    <span class="n">fgt_host</span><span class="p">:</span> <span class="s1">&#39;192.168.190.171&#39;</span>
    <span class="n">fgt_user</span><span class="p">:</span> <span class="s1">&#39;admin&#39;</span>
    <span class="n">fgt_pass</span><span class="p">:</span> <span class="s1">&#39;password&#39;</span>
    <span class="c1"># =====================================================================================</span>
    <span class="n">script_path</span><span class="p">:</span> <span class="s1">&#39;/tmp/fgt.shell.task&#39;</span>
  <span class="n">tasks</span><span class="p">:</span>
   <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">Prepare</span> <span class="n">The</span> <span class="n">Shell</span> <span class="n">Scrit</span> <span class="n">Template</span><span class="o">.</span>
     <span class="n">raw</span><span class="p">:</span> <span class="o">|</span>
            <span class="n">cat</span> <span class="o">&gt;</span> <span class="p">{{</span><span class="n">script_path</span> <span class="p">}}</span> <span class="o">&lt;&lt;</span> <span class="n">EOF_OUTER</span>
            <span class="c1"># /bin/bash</span>
            <span class="c1"># Please make sure tool sshpass is installed. e.g. on Debian/Ubuntu, apt-get install sshpass.</span>
            <span class="c1"># Optionally you can pass some parameters.</span>
            <span class="c1"># The character `a` at second line below is to avoid post-login-banner barrier.</span>
            <span class="n">sshpass</span> <span class="o">-</span><span class="n">p</span> <span class="s1">&#39;{{ fgt_pass }}&#39;</span> <span class="n">ssh</span> <span class="o">-</span><span class="n">o</span> <span class="n">StrictHostKeyChecking</span><span class="o">=</span><span class="n">no</span> <span class="p">{{</span> <span class="n">fgt_user</span> <span class="p">}}</span><span class="o">@</span><span class="p">{{</span> <span class="n">fgt_host</span> <span class="p">}}</span> <span class="o">&lt;&lt;</span><span class="n">EOF</span>
            <span class="n">a</span>
            <span class="c1"># ====================== Edit Your Commands Below =============================================</span>
            <span class="n">config</span> <span class="n">system</span> <span class="k">global</span>
            <span class="nb">set</span> <span class="n">pre</span><span class="o">-</span><span class="n">login</span><span class="o">-</span><span class="n">banner</span> <span class="s1">&#39;\${1:-disbale}&#39;</span>
            <span class="nb">set</span> <span class="n">post</span><span class="o">-</span><span class="n">login</span><span class="o">-</span><span class="n">banner</span> <span class="s1">&#39;\${2:-disable}&#39;</span>
            <span class="n">end</span>
            <span class="c1"># ==============================================================================================</span>
            <span class="n">EOF</span>
            <span class="n">EOF_OUTER</span>


   <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">Execute</span> <span class="n">The</span> <span class="n">Cli</span> <span class="n">Commands</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">g</span><span class="o">.</span> <span class="n">enable</span> <span class="n">pre</span><span class="o">-</span> <span class="ow">and</span> <span class="n">post</span><span class="o">-</span> <span class="n">login</span> <span class="n">banner</span><span class="o">.</span>
     <span class="n">raw</span><span class="p">:</span> <span class="o">|</span>
            <span class="n">chmod</span> <span class="o">+</span><span class="n">x</span> <span class="p">{{</span> <span class="n">script_path</span> <span class="p">}}</span> <span class="o">&amp;&amp;</span> <span class="p">{{</span> <span class="n">script_path</span> <span class="p">}}</span> <span class="n">enable</span> <span class="n">enable</span>
     <span class="n">args</span><span class="p">:</span>
       <span class="n">executable</span><span class="p">:</span> <span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">bash</span>
</pre></div>
</div>
</div>
<div class="section" id="how-to-use-the-set-fact-module-in-a-task">
<h2>How to use the set_fact module in a task?<a class="headerlink" href="#how-to-use-the-set-fact-module-in-a-task" title="Permalink to this headline">¶</a></h2>
<p>In Ansible, there’s an important module that works with variables and is used to get or set variable values, which is <code class="docutils literal notranslate"><span class="pre">set_fact</span></code>.
This module is used to set new variables and these variables are available to subsequent plays in a playbook.
Using set_fact, we can store the value after preparing it on the fly using certain task.</p>
<p>The following example will show you how set_fact module can be used in a task to configure the firewall address group.</p>
<p><strong>Configuring the firewall address group with a string type of variable that contains all the grouped firewall addresses:</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">hosts</span><span class="p">:</span> <span class="n">fortigateslab</span>
  <span class="n">connection</span><span class="p">:</span> <span class="n">httpapi</span>
  <span class="n">collections</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">fortinet</span><span class="o">.</span><span class="n">fortios</span>
  <span class="nb">vars</span><span class="p">:</span>
    <span class="n">vdom</span><span class="p">:</span> <span class="s1">&#39;root&#39;</span>
    <span class="n">ansible_httpapi_use_ssl</span><span class="p">:</span> <span class="n">yes</span>
    <span class="n">ansible_httpapi_validate_certs</span><span class="p">:</span> <span class="n">no</span>
    <span class="n">ansible_httpapi_port</span><span class="p">:</span> <span class="mi">443</span>
    <span class="n">demo_input</span><span class="p">:</span> <span class="s1">&#39;login.microsoftonline.com, login.microsoft.com, login.windows.net&#39;</span>
    <span class="n">demo_members</span><span class="p">:</span> <span class="p">[]</span>
  <span class="n">tasks</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">Process</span> <span class="nb">input</span> <span class="n">content</span>
      <span class="n">set_fact</span><span class="p">:</span>
        <span class="n">demo_members</span><span class="p">:</span> <span class="s2">&quot;{{ demo_members + [{&#39;name&#39;: item.strip(&#39; &#39;)}] }}&quot;</span>
      <span class="n">with_items</span><span class="p">:</span>
        <span class="o">-</span> <span class="s2">&quot;{{demo_input.split(&#39;,&#39;)}}&quot;</span>

    <span class="o">-</span> <span class="n">debug</span><span class="p">:</span>
        <span class="n">var</span><span class="p">:</span> <span class="n">demo_members</span>

    <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">Configure</span> <span class="n">Firewall</span> <span class="n">Schedule</span> <span class="n">Recurring</span>
      <span class="n">fortios_firewall_addrgrp</span><span class="p">:</span>
        <span class="n">vdom</span><span class="p">:</span>  <span class="s1">&#39;{{ vdom }}&#39;</span>
        <span class="n">state</span><span class="p">:</span> <span class="s1">&#39;present&#39;</span>
        <span class="n">enable_log</span><span class="p">:</span> <span class="kc">True</span>
        <span class="n">access_token</span><span class="p">:</span> <span class="s1">&#39;{{ fortios_access_token }}&#39;</span>
        <span class="n">firewall_addrgrp</span><span class="p">:</span>
          <span class="n">name</span><span class="p">:</span> <span class="s1">&#39;group_1&#39;</span>
          <span class="n">comment</span><span class="p">:</span> <span class="s1">&#39;created via Ansible&#39;</span>
          <span class="n">visibility</span><span class="p">:</span> <span class="s1">&#39;enable&#39;</span>
          <span class="n">member</span><span class="p">:</span> <span class="s1">&#39;{{ demo_members }}&#39;</span>
</pre></div>
</div>
<p>In the example, the first task is preprocessing the input content.
Specifically, it splits the input content with comma to get a list of the firewall addresses.
Then it appends the each address to the variable demo_members.
So the demo_members variable can be assigned to the variable members in the subsequent play.</p>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="playbook.html" class="btn btn-neutral float-left" title="Run Your First Playbook" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="help.html" class="btn btn-neutral float-right" title="Get Help" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020-2021, Fortinet.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>